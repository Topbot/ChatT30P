using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using Core;
using ChatT30P.Contracts;
using ChatT30P.Controllers.Models;
using TopTools;
using System.Linq;
using System.Linq.Dynamic;

namespace ChatT30P.Controllers.Data
{
    public class PeriscopeRepository : IPeriscopeRepository
    {
        /// <summary>
        /// Google Plus list
        /// </summary>
        /// <param name="take">Items to take</param>
        /// <param name="skip">Items to skip</param>
        /// <param name="filter">Filter expression</param>
        /// <param name="min">Memebers min</param>
        /// <param name="max">Memebers max</param>
        /// <param name="order">Sort order</param>
        /// <returns>List of comments</returns>
        public IEnumerable<PeriscopeItem> GetPeriscope(int take = 10, int skip = 0,
            int min = 0, int max = int.MaxValue,
            string filter = "", string order = "")
        {
            using (var db = new t30pDataContext { CommandTimeout = 400 })
            {
                //??????????? ?? ?????????
                var query = db.top_periscopes.AsQueryable();
                if (max != 0)
                {
                    query = query.Where(i => i.followers >= min && i.followers <= max);
                }
                if (!string.IsNullOrEmpty(filter))
                {
                    query = query.Where(
                        i =>
                            i.id == "periscope.tv/"+filter.ToLower() || i.name.Contains(filter) /*|| (i.about!=null && i.about.Contains(filter))*/);
                }
                if (string.IsNullOrEmpty(order)) order = "followers desc";

                // if take passed in as 0, return all
                if (take == 0) take = 20000;

                return (from i in query.OrderBy(order)
                    select i).Skip(skip).Take(take).ToList().Select(ToJson);
            }
        }

        //String.Format("{0}/{1}_{2}{3}.jpg",
        //                    post.User.Id,
        //                    (int) Math.Floor(DateTime.Now.Day / 2.0),
        //                    DateTime.Now.Hour,

        private PeriscopeItem ToJson(top_periscope item)
        {
            return new PeriscopeItem
            {
                Id = item.id.Split('/')[1],//??????? ????????? periscope.tv/
                S = item.status,
                T = GetTime(item.lastupdated),
                A = item.about ?? String.Empty,
                M = item.followers,
                F = item.friends,
                H = item.hearts,
                N = item.name,
                V = item.vip ?? String.Empty,
                G = item.gender ?? String.Empty,
                Y = (float)Math.Round(item.age, 1),
                P = GetPreview(item.lastupdated)
            };
        }

        /// <summary>
        /// ????????? ?????
        /// </summary>
        /// <param name="lastupdated"></param>
        /// <returns></returns>
        private string GetPreview(DateTime lastupdated)
        {
            return String.Format("{0}_{1}",
                            (int)Math.Floor(lastupdated.Day / 2.0),
                            lastupdated.Hour);
        }

        /// <summary>
        /// ????? ??????????
        /// </summary>
        /// <param name="lastupdated"></param>
        /// <returns></returns>
        private string GetTime(DateTime lastupdated)
        {
            var dif = DateTime.UtcNow - lastupdated;
            if (dif < TimeSpan.FromHours(2))
            {
                return String.Format("{0} ?????", Math.Round(dif.TotalMinutes, 0));
            }
            else if (dif < TimeSpan.FromDays(2))
            {
                return String.Format("{0} ?????", Math.Round(dif.TotalHours, 0));
            }
            else if (dif < TimeSpan.FromDays(31))
            {
                return String.Format("{0} ????", Math.Round(dif.TotalDays, 0));
            }
            else
            {
                return lastupdated.ToString("dd-MM-yyyy");
            }
        }
    }
}
